name: Build, Test, and Security Scan

on: [push]

jobs:

  build:
    name: Build Job
    runs-on: ubuntu-latest 

    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4

      - name: 2. Run build commands
        run: |
          echo "Starting the build process..."
          mkdir build_artifacts      # Crée un dossier pour les fichiers "construits"
          # Assurez-vous que 'index.html' existe à la racine
          cp index.html build_artifacts/ 
          echo "Build complete."

      - name: 3. Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output 
          path: build_artifacts/ 

  functional-test-job:
    name: Functional Test Job
    runs-on: ubuntu-latest
    needs: build 

    steps:
      - name: 1. Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output 

      - name: 2. Run test commands
        run: |
          echo "Starting tests on build artifacts..."
          
          # Test 1: Vérifie que le fichier existe
          test -f "index.html"
          
          # Test 2: Vérifie que le contenu attendu est présent
          grep -q "Welcome" index.html
          grep -q "OWASP" index.html
          
          echo "All functional tests passed!"

  security-scan:
    name: SAST Security Scan
    runs-on: ubuntu-latest
    needs: build 

    permissions:
      actions: read
      contents: read
      security-events: write 

    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4

      - name: 2. Run Semgrep SAST Scan
        uses: semgrep/semgrep-action@v2
        with:
          config: "p/default"