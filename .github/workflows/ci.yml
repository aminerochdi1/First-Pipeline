name: Build, Test, Scan, and Deploy to Pages
on: [push]

jobs:

  functional-test:
    name: Functional Test
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4
      - name: 2. Run test commands
        run: |
          echo "Running functional tests..."
          test -f "index.html"
          grep -q "Welcome" index.html
          grep -q "OWASP" index.html
          echo "All functional tests passed!"

  sast-scan:
    name: SAST Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4
      - name: 2. Run Semgrep SAST Scan
        uses: semgrep/semgrep-action@v1
        with:
          config: "p/default"

  deploy-to-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    # Ne se déploie que si les deux tests réussissent
    needs: [functional-test, sast-scan]
    
    # Donne la permission d'écrire sur la branche gh-pages
    permissions:
      contents: write

    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4

      - name: 2. Deploy to GitHub Pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          # Token automatique de GitHub
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Publie le contenu de la racine du projet
          publish_dir: .
          keep_files: false